<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Creative Sampler Prototype</title>
  <!-- å¼•å…¥ Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-p8mT8kSfqgnQlVra22XlL1lQ2xhnOqULdkQk5RgAnk4rHL6kuMkGbkZw8n5o0YvXgpv1V9j9W6ozJrD3Aqz2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- å¼•å…¥ WaveSurfer.js -->
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <style>
    /* ===== åŸºæœ¬æ’ç‰ˆè¨­å®š ===== */
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f0f0f0;
    }

    h1 {
      margin-bottom: 1rem;
      color: #333;
    }

    .sampler-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      width: 100%;
      max-width: 800px;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* ===== ä¸Šæ’ã€ä¸‹æ’å®¹å™¨ ===== */
    .top-row, .bottom-row {
      display: flex;
      gap: 1rem;
    }

    /* ===== å…±ç”¨åœ“å½¢æŒ‰éˆ• ===== */
    .circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-weight: bold;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      outline: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .circle:active {
      transform: none;
    }

    /* ===== æŒ‰éˆ•ç‹€æ…‹æ¨£å¼ ===== */
    .recording {
      background-color: #ff4d4d !important; /* é®®æ˜ç´… */
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .select-mode-active {
      background-color: #6c757d !important; /* æ”¹è®Šé¸æ“‡æŒ‰éˆ•é¡è‰² */
    }

    /* ===== ä¸Šæ’æŒ‰éˆ•æ¨£å¼ ===== */
    #recordBtn {
      background-color: #e74c3c; /* é®®æ˜ç´… */
    }
    #selectBtn {
      background-color: #3498db; /* é®®æ˜è— */
    }
    #deleteBtn {
      background-color: #e67e22; /* é®®æ˜æ©™ */
    }

    /* ===== ä¸‹æ’äº”å€‹æ’­æ”¾æŒ‰éˆ•ä¸åŒé¡è‰² ===== */
    .pad1 {
      background-color: #1abc9c; /* é’ç¶  */
    }
    .pad2 {
      background-color: #9b59b6; /* ç´« */
    }
    .pad3 {
      background-color: #f1c40f; /* é»ƒ */
    }
    .pad4 {
      background-color: #e74c3c; /* ç´… */
    }
    .pad5 {
      background-color: #34495e; /* æ·±è— */
    }

    /* ===== éŸ³æª”ç‹€æ…‹æ¨™ç¤º ===== */
    .pad-container {
      position: relative;
    }

    .pad.has-audio::after {
      content: 'ğŸ”Š';
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 1rem;
    }

    /* ===== è¢«é¸æ“‡æŒ‰éˆ•çš„æ¨£å¼ ===== */
    .pad.selected {
      outline: 3px solid #ffeb3b;
      box-shadow: 0 0 0 3px rgba(255, 235, 59, 0.5);
    }

    /* ===== éŒ„éŸ³è¨ˆæ™‚å™¨æ¨£å¼ ===== */
    .timer {
      font-size: 1rem;
      margin-top: 0.5rem;
      color: #333;
    }

    /* ===== æ¨¡å¼æŒ‡ç¤ºå™¨æ¨£å¼ ===== */
    .mode-indicator {
      margin-top: 1rem;
      font-size: 1rem;
      color: #333;
    }

    .mode-indicator.selecting {
      color: #ff9800;
      font-weight: bold;
    }

    /* ===== æ“ä½œèªªæ˜æ¨£å¼ ===== */
    .instructions {
      margin-top: 1.5rem;
      font-size: 0.9rem;
      color: #555;
      max-width: 600px;
      text-align: center;
    }

    /* ===== å·¥å…·æç¤ºæ¨£å¼ ===== */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      
      /* å®šä½ */
      position: absolute;
      z-index: 1;
      bottom: 125%; /* åœ¨æŒ‰éˆ•ä¸Šæ–¹ */
      left: 50%;
      margin-left: -60px;
      
      /* å‹•ç•« */
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* ===== éŸ¿æ‡‰å¼è¨­è¨ˆ ===== */
    @media (max-width: 600px) {
      .circle {
        width: 50px;
        height: 50px;
        font-size: 0.9rem;
      }

      .sampler-container {
        gap: 1rem;
      }

      .timer {
        font-size: 0.9rem;
      }

      /* èª¿æ•´æ³¢å½¢åœ–å®¹å™¨å¯¬åº¦ */
      #waveform {
        width: 90%;
      }
    }

    /* ===== æ³¢å½¢åœ–å®¹å™¨æ¨£å¼ ===== */
    #waveform {
      width: 600px;
      height: 128px;
      margin-top: 1rem;
      display: none; /* åˆå§‹éš±è—ï¼Œåƒ…åœ¨é¸æ“‡æ¨¡å¼ä¸‹é¡¯ç¤º */
    }

    /* ===== æ¶ˆæ¯é¡¯ç¤ºå€åŸŸ ===== */
    .message {
      font-size: 1rem;
      margin-top: 0.5rem;
      color: #333;
      min-height: 1.2rem; /* ä¿ç•™ç©ºé–“ä»¥é¿å…å¸ƒå±€è·³å‹• */
      transition: opacity 0.5s ease;
      opacity: 1;
    }

    .message.hidden {
      opacity: 0;
    }

    /* å¯é¸ï¼šä¸åŒé¡å‹çš„æ¶ˆæ¯æ¨£å¼ */
    .message.success {
      color: #28a745;
    }

    .message.error {
      color: #dc3545;
    }

    /* ===== åœæ­¢éŒ„éŸ³æŒ‰éˆ•æ¨£å¼ ===== */
    #stopBtn {
      background-color: #ff9800; /* æ©™è‰² */
      display: none; /* åˆå§‹éš±è— */
      margin-left: 1rem;
    }

    /* ===== éŒ„éŸ³æ§åˆ¶å€åŸŸ ===== */
    .record-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* ===== éŒ„éŸ³æ™‚é•·é¸æ“‡å™¨ ===== */
    .duration-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .duration-selector label {
      font-size: 0.9rem;
      color: #333;
    }

    .duration-selector select {
      padding: 0.3rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* ===== éŒ„éŸ³æš«åœ/ç¹¼çºŒæŒ‰éˆ•æ¨£å¼ ===== */
    #pauseBtn, #resumeBtn {
      background-color: #3498db; /* è—è‰² */
      display: none; /* åˆå§‹éš±è— */
    }
  </style>
</head>
<body>
  <h1>Creative Sampler Prototype</h1>
  <div class="sampler-container">
    <!-- ä¸Šæ’ï¼šéŒ„éŸ³ã€é¸æ“‡ã€åˆªé™¤ -->
    <div class="top-row">
      <button id="recordBtn" class="circle tooltip" aria-label="éŒ„éŸ³æŒ‰éˆ•">
        <i class="fas fa-microphone"></i>
        <span class="tooltiptext">éŒ„éŸ³</span>
      </button>
      <button id="selectBtn" class="circle tooltip" aria-label="é¸æ“‡æ¨¡å¼æŒ‰éˆ•">
        <i class="fas fa-hand-pointer"></i>
        <span class="tooltiptext">é¸æ“‡æ¨¡å¼</span>
      </button>
      <button id="deleteBtn" class="circle tooltip" aria-label="åˆªé™¤éŸ³æª”æŒ‰éˆ•">
        <i class="fas fa-trash"></i>
        <span class="tooltiptext">åˆªé™¤éŸ³æª”</span>
      </button>
    </div>

    <!-- éŒ„éŸ³è¨ˆæ™‚å™¨ -->
    <div class="timer" id="timer">00:00</div>

    <!-- æ¶ˆæ¯é¡¯ç¤ºå€åŸŸ -->
    <div class="message" id="message"></div>

    <!-- æ³¢å½¢åœ–å®¹å™¨ -->
    <div id="waveform"></div>

    <!-- éŒ„éŸ³æ§åˆ¶å€åŸŸ -->
    <div class="record-controls">
      <button id="stopBtn" class="circle tooltip" aria-label="åœæ­¢éŒ„éŸ³æŒ‰éˆ•">
        <i class="fas fa-stop"></i>
        <span class="tooltiptext">åœæ­¢éŒ„éŸ³</span>
      </button>
      <button id="pauseBtn" class="circle tooltip" aria-label="æš«åœéŒ„éŸ³æŒ‰éˆ•">
        <i class="fas fa-pause"></i>
        <span class="tooltiptext">æš«åœéŒ„éŸ³</span>
      </button>
      <button id="resumeBtn" class="circle tooltip" aria-label="ç¹¼çºŒéŒ„éŸ³æŒ‰éˆ•">
        <i class="fas fa-play"></i>
        <span class="tooltiptext">ç¹¼çºŒéŒ„éŸ³</span>
      </button>
    </div>

    <!-- éŒ„éŸ³æ™‚é•·é¸æ“‡å™¨ -->
    <div class="duration-selector">
      <label for="duration">éŒ„éŸ³æ™‚é•·ï¼š</label>
      <select id="duration">
        <option value="2">2 ç§’</option>
        <option value="5">5 ç§’</option>
        <option value="10">10 ç§’</option>
        <option value="15">15 ç§’</option>
      </select>
    </div>

    <!-- ä¸‹æ’ï¼šäº”å€‹æ’­æ”¾æŒ‰éˆ• -->
    <div class="bottom-row">
      <div class="pad-container">
        <button class="circle pad pad1 tooltip" data-index="0" aria-label="æ’­æ”¾æŒ‰éˆ• 1">
          <span>1</span>
          <span class="tooltiptext">æ’­æ”¾éŸ³æª” 1</span>
        </button>
      </div>
      <div class="pad-container">
        <button class="circle pad pad2 tooltip" data-index="1" aria-label="æ’­æ”¾æŒ‰éˆ• 2">
          <span>2</span>
          <span class="tooltiptext">æ’­æ”¾éŸ³æª” 2</span>
        </button>
      </div>
      <div class="pad-container">
        <button class="circle pad pad3 tooltip" data-index="2" aria-label="æ’­æ”¾æŒ‰éˆ• 3">
          <span>3</span>
          <span class="tooltiptext">æ’­æ”¾éŸ³æª” 3</span>
        </button>
      </div>
      <div class="pad-container">
        <button class="circle pad pad4 tooltip" data-index="3" aria-label="æ’­æ”¾æŒ‰éˆ• 4">
          <span>4</span>
          <span class="tooltiptext">æ’­æ”¾éŸ³æª” 4</span>
        </button>
      </div>
      <div class="pad-container">
        <button class="circle pad pad5 tooltip" data-index="4" aria-label="æ’­æ”¾æŒ‰éˆ• 5">
          <span>5</span>
          <span class="tooltiptext">æ’­æ”¾éŸ³æª” 5</span>
        </button>
      </div>
    </div>

    <!-- æ¨¡å¼æŒ‡ç¤ºå™¨ -->
    <div class="mode-indicator" id="modeIndicator">ä¸€èˆ¬æ¨¡å¼</div>

    <!-- æ“ä½œèªªæ˜ -->
    <div class="instructions">
      <p>1. é»æ“Šã€Œé¸æ“‡æ¨¡å¼ã€é€²å…¥é¸æ“‡æ¨¡å¼ã€‚</p>
      <p>2. é¸æ“‡ä¸‹æ’æŒ‰éˆ•å¾Œï¼Œå¯éŒ„éŸ³æˆ–åˆªé™¤éŸ³æª”ã€‚</p>
      <p>3. é›¢é–‹é¸æ“‡æ¨¡å¼å¾Œï¼Œé»æ“Šä¸‹æ’æŒ‰éˆ•æ’­æ”¾éŸ³æª”ã€‚</p>
      <p>4. ä½¿ç”¨éµç›¤ Q W E R T å¿«é€Ÿæ§åˆ¶å°æ‡‰æŒ‰éˆ•ã€‚</p>
    </div>
  </div>

  <script>
    // ===== å…¨å±€è®Šæ•¸ =====
    const audioClips = [[], [], [], [], []]; // å„²å­˜äº”å€‹æŒ‰éˆ•çš„å¤šå€‹éŸ³æª”
    let selectedPadIndex = null;
    let isSelectMode = false;
    let mediaRecorder = null;
    let mediaStream = null;
    let audioChunks = [];
    let hasRequestedMicrophone = false;
    let timerInterval;
    let currentRecordingDuration = 2; // é è¨­éŒ„éŸ³æ™‚é•·ï¼ˆç§’ï¼‰
    let wavesurfer = null; // WaveSurfer.js å¯¦ä¾‹

    // å–å¾— DOM å…ƒç´ 
    const recordBtn = document.getElementById('recordBtn');
    const selectBtn = document.getElementById('selectBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const stopBtn = document.getElementById('stopBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const padButtons = document.querySelectorAll('.pad');
    const timerDisplay = document.getElementById('timer');
    const modeIndicator = document.getElementById('modeIndicator');
    const messageDisplay = document.getElementById('message');
    const durationSelector = document.getElementById('duration');
    const waveformContainer = document.getElementById('waveform');

    // ===== è¼”åŠ©å‡½å¼ =====
    /**
     * é¡¯ç¤ºæ¶ˆæ¯
     * @param {string} text æ¶ˆæ¯å…§å®¹
     * @param {string} type æ¶ˆæ¯é¡å‹ï¼ˆ'success' æˆ– 'error'ï¼‰
     * @param {number} duration æ¶ˆæ¯é¡¯ç¤ºæŒçºŒæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
     */
    function showMessage(text, type = '', duration = 3000) {
      messageDisplay.textContent = text;
      messageDisplay.className = 'message'; // é‡ç½®é¡åˆ¥

      if (type) {
        messageDisplay.classList.add(type);
      }

      // ç¢ºä¿æ¶ˆæ¯å¯è¦‹
      messageDisplay.classList.remove('hidden');

      if (duration > 0) {
        setTimeout(() => {
          messageDisplay.classList.add('hidden');
        }, duration);
      }
    }

    /**
     * æ›´æ–°éŒ„éŸ³æ™‚é•·
     */
    function updateRecordingDuration() {
      const selectedValue = durationSelector.value;
      currentRecordingDuration = parseInt(selectedValue, 10);
    }

    /**
     * åˆå§‹åŒ– WaveSurfer.js
     */
    function initializeWaveSurfer() {
      wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: '#ddd',
        progressColor: '#ff9800',
        height: 128,
        responsive: true
      });

      // æ’­æ”¾çµæŸæ™‚è§¸ç™¼
      wavesurfer.on('finish', () => {
        showMessage('éŸ³è¨Šæ’­æ”¾å®Œç•¢ã€‚', 'success');
      });

      // æ³¢å½¢è¼‰å…¥éŒ¯èª¤
      wavesurfer.on('error', (e) => {
        console.error(e);
        showMessage('æ³¢å½¢è¼‰å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
      });
    }

    // åˆå§‹åŒ– WaveSurfer.js
    initializeWaveSurfer();

    // ===== äº‹ä»¶ç›£è½ =====
    // 1. ã€Œé¸æ“‡ã€æŒ‰éˆ•ï¼šåˆ‡æ›é¸æ“‡æ¨¡å¼
    selectBtn.addEventListener('click', async () => {
      isSelectMode = !isSelectMode;

      if (isSelectMode) {
        selectBtn.classList.add('select-mode-active');
        modeIndicator.textContent = 'é¸æ“‡æ¨¡å¼å•Ÿå‹•';
        modeIndicator.classList.add('selecting');
        showMessage('é¸æ“‡æ¨¡å¼å·²å•Ÿå‹•');

        // é¡¯ç¤ºæ³¢å½¢åœ–å®¹å™¨
        waveformContainer.style.display = 'block';

        // å¦‚æœå°šæœªè«‹æ±‚ééº¥å…‹é¢¨æ¬Šé™ï¼Œç¾åœ¨è«‹æ±‚
        if (!hasRequestedMicrophone) {
          try {
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            hasRequestedMicrophone = true;
            showMessage('éº¥å…‹é¢¨æ¬Šé™å·²ç²å–', 'success');
          } catch (error) {
            console.error('ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™:', error);
            showMessage('éŒ„éŸ³åŠŸèƒ½éœ€è¦éº¥å…‹é¢¨æ¬Šé™ï¼Œè«‹å…è¨±å¾Œå†è©¦ä¸€æ¬¡ã€‚', 'error');
            // è‡ªå‹•é€€å‡ºé¸æ“‡æ¨¡å¼
            isSelectMode = false;
            selectBtn.classList.remove('select-mode-active');
            modeIndicator.textContent = 'ä¸€èˆ¬æ¨¡å¼';
            modeIndicator.classList.remove('selecting');
            // éš±è—æ³¢å½¢åœ–å®¹å™¨
            waveformContainer.style.display = 'none';
          }
        }
      } else {
        selectBtn.classList.remove('select-mode-active');
        modeIndicator.textContent = 'ä¸€èˆ¬æ¨¡å¼';
        modeIndicator.classList.remove('selecting');
        showMessage('å·²é€€å‡ºé¸æ“‡æ¨¡å¼');
        // é›¢é–‹é¸æ“‡æ¨¡å¼æ™‚ï¼Œæ¸…ç©ºä»»ä½•é¸æ“‡
        clearSelectedPad();
        // éš±è—æ³¢å½¢åœ–å®¹å™¨ä¸¦æ¸…é™¤æ³¢å½¢
        waveformContainer.style.display = 'none';
        wavesurfer.empty();
      }
    });

    // 2. ä¸‹æ’æŒ‰éˆ•ï¼šåœ¨é¸æ“‡æ¨¡å¼ä¸‹é¸å–è¦ç·¨è¼¯çš„æŒ‰éˆ•ï¼›æˆ–åœ¨ä¸€èˆ¬æ¨¡å¼ä¸‹æ’­æ”¾éŸ³æª”
    padButtons.forEach((padBtn) => {
      padBtn.addEventListener('click', () => {
        const index = parseInt(padBtn.dataset.index, 10);

        // æ·»åŠ é»æ“Šæ•ˆæœ
        padBtn.classList.add('active');
        setTimeout(() => {
          padBtn.classList.remove('active');
        }, 100);

        if (isSelectMode) {
          selectPad(index);
        } else {
          playAudioClip(index);
          // æ·»åŠ æ’­æ”¾æ•ˆæœ
          padBtn.classList.add('playing');
          setTimeout(() => {
            padBtn.classList.remove('playing');
          }, 300);
        }
      });
    });

    // 3. ã€ŒéŒ„éŸ³ã€æŒ‰éˆ•ï¼šåœ¨é¸æ“‡æ¨¡å¼ä¸‹éŒ„è£½éŸ³æª”
    recordBtn.addEventListener('click', () => {
      if (!isSelectMode || selectedPadIndex === null) {
        showMessage('è«‹å…ˆé€²å…¥é¸æ“‡æ¨¡å¼ä¸¦é¸æ“‡ä¸€å€‹æŒ‰éˆ•!', 'error');
        return;
      }

      if (!hasRequestedMicrophone || !mediaStream) {
        showMessage('éŒ„éŸ³åŠŸèƒ½å°šæœªå•Ÿç”¨ï¼Œè«‹é€²å…¥é¸æ“‡æ¨¡å¼ä»¥å•Ÿç”¨éº¥å…‹é¢¨ã€‚', 'error');
        return;
      }

      try {
        mediaRecorder = new MediaRecorder(mediaStream);
      } catch (error) {
        console.error('ç„¡æ³•å»ºç«‹ MediaRecorder:', error);
        showMessage('éŒ„éŸ³å¤±æ•—ï¼Œç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤åŠŸèƒ½ã€‚', 'error');
        return;
      }

      audioChunks = [];

      mediaRecorder.addEventListener('dataavailable', (event) => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      });

      mediaRecorder.addEventListener('stop', () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioClips[selectedPadIndex].push(audioBlob);
        padButtons[selectedPadIndex].classList.add('has-audio');
        showMessage(`å·²å®ŒæˆéŒ„éŸ³ï¼Œå„²å­˜åœ¨æŒ‰éˆ• ${selectedPadIndex + 1}`, 'success');

        stopTimer();
        recordBtn.classList.remove('recording');
        // éš±è—éŒ„éŸ³æ§åˆ¶æŒ‰éˆ•
        stopBtn.style.display = 'none';
        pauseBtn.style.display = 'none';
        resumeBtn.style.display = 'none';

        // è¼‰å…¥æ³¢å½¢åœ–
        loadWaveform(audioBlob);
      });

      mediaRecorder.start();
      showMessage('é–‹å§‹éŒ„éŸ³...');
      startTimer();
      recordBtn.classList.add('recording');

      // é¡¯ç¤ºåœæ­¢éŒ„éŸ³æŒ‰éˆ•
      stopBtn.style.display = 'inline-block';

      // è¨­å®šéŒ„éŸ³æ™‚é•·
      setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
      }, currentRecordingDuration * 1000);
    });

    // 4. ã€Œåœæ­¢éŒ„éŸ³ã€æŒ‰éˆ•ï¼šæ‰‹å‹•åœæ­¢éŒ„éŸ³
    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        showMessage('éŒ„éŸ³å·²åœæ­¢', 'success');
        recordBtn.classList.remove('recording');
        // éš±è—åœæ­¢éŒ„éŸ³æŒ‰éˆ•
        stopBtn.style.display = 'none';
        pauseBtn.style.display = 'none';
        resumeBtn.style.display = 'none';
      }
    });

    // 5. ã€Œæš«åœéŒ„éŸ³ã€æŒ‰éˆ•
    pauseBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.pause();
        showMessage('éŒ„éŸ³å·²æš«åœ', 'success');
        pauseBtn.style.display = 'none';
        resumeBtn.style.display = 'inline-block';
      }
    });

    // 6. ã€Œç¹¼çºŒéŒ„éŸ³ã€æŒ‰éˆ•
    resumeBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state === 'paused') {
        mediaRecorder.resume();
        showMessage('ç¹¼çºŒéŒ„éŸ³...', 'success');
        pauseBtn.style.display = 'inline-block';
        resumeBtn.style.display = 'none';
      }
    });

    // 7. ã€Œåˆªé™¤ã€æŒ‰éˆ•ï¼šåœ¨é¸æ“‡æ¨¡å¼ä¸‹åˆªé™¤æŒ‡å®šæŒ‰éˆ•çš„éŸ³æª”
    deleteBtn.addEventListener('click', () => {
      if (!isSelectMode || selectedPadIndex === null) {
        showMessage('è«‹å…ˆé€²å…¥é¸æ“‡æ¨¡å¼ä¸¦é¸æ“‡ä¸€å€‹æŒ‰éˆ•!', 'error');
        return;
      }

      // åˆªé™¤å°æ‡‰æŒ‰éˆ•çš„æ‰€æœ‰éŸ³æª”
      audioClips[selectedPadIndex] = [];
      padButtons[selectedPadIndex].classList.remove('has-audio');
      showMessage(`å·²åˆªé™¤æŒ‰éˆ• ${selectedPadIndex + 1} çš„æ‰€æœ‰éŸ³æª”`, 'success');
      // æ¸…é™¤æ³¢å½¢åœ–
      wavesurfer.empty();
    });

    // 8. éŒ„éŸ³æ™‚é•·é¸æ“‡å™¨
    durationSelector.addEventListener('change', () => {
      updateRecordingDuration();
      showMessage(`éŒ„éŸ³æ™‚é•·å·²è¨­å®šç‚º ${currentRecordingDuration} ç§’`, 'success');
    });

    // 9. æ·»åŠ éµç›¤æ§åˆ¶
    document.addEventListener('keydown', (event) => {
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
        return;
      }

      const keyMap = {
        'q': 0,
        'w': 1,
        'e': 2,
        'r': 3,
        't': 4
      };

      const index = keyMap[event.key.toLowerCase()];
      
      if (index !== undefined) {
        const padBtn = padButtons[index];
        
        // æ·»åŠ é»æ“Šæ•ˆæœ
        padBtn.classList.add('active');
        setTimeout(() => {
          padBtn.classList.remove('active');
        }, 100);

        if (isSelectMode) {
          selectPad(index);
        } else {
          playAudioClip(index);
          // æ·»åŠ æ’­æ”¾æ•ˆæœ
          padBtn.classList.add('playing');
          setTimeout(() => {
            padBtn.classList.remove('playing');
          }, 300);
        }
      }
    });

    // ===== è¼”åŠ©å‡½å¼ =====
    // é¸æ“‡ä¸‹æ’æŒ‰éˆ•
    function selectPad(index) {
      // å¦‚æœå·²ç¶“é¸æ“‡éå…¶ä»–æŒ‰éˆ•ï¼Œå…ˆæ¸…é™¤èˆŠçš„
      clearSelectedPad();
      selectedPadIndex = index;
      padButtons[index].classList.add('selected');
      showMessage(`å·²é¸æ“‡æŒ‰éˆ• ${index + 1}`, 'success');

      // è¼‰å…¥æœ€æ–°éŒ„éŸ³çš„æ³¢å½¢åœ–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (audioClips[index].length > 0) {
        const latestClip = audioClips[index][audioClips[index].length - 1];
        loadWaveform(latestClip);
      } else {
        // æ¸…é™¤æ³¢å½¢åœ–
        wavesurfer.empty();
      }
    }

    // æ¸…é™¤ç•¶å‰é¸æ“‡çš„æŒ‰éˆ•
    function clearSelectedPad() {
      if (selectedPadIndex !== null) {
        padButtons[selectedPadIndex].classList.remove('selected');
        showMessage(`å·²å–æ¶ˆé¸æ“‡æŒ‰éˆ• ${selectedPadIndex + 1}`, 'success');
      }
      selectedPadIndex = null;
    }

    // æ’­æ”¾å·²éŒ„è£½éŸ³æª”ä¸¦åŒæ­¥æ³¢å½¢åœ–
    function playAudioClip(index) {
      if (audioClips[index].length === 0) {
        showMessage('æ­¤æŒ‰éˆ•å°šæœªéŒ„è£½éŸ³æª”', 'error');
        return;
      }

      // æ’­æ”¾æœ€æ–°çš„éŒ„éŸ³
      const latestClip = audioClips[index][audioClips[index].length - 1];
      const audioURL = URL.createObjectURL(latestClip);
      
      // è¼‰å…¥æ³¢å½¢åœ–
      wavesurfer.load(audioURL);
      wavesurfer.on('ready', () => {
        wavesurfer.play();
        showMessage(`æ­£åœ¨æ’­æ”¾éŸ³æª” ${index + 1}...`, 'success');
      });
      wavesurfer.on('finish', () => {
        showMessage(`éŸ³æª” ${index + 1} æ’­æ”¾å®Œç•¢ã€‚`, 'success');
      });
      wavesurfer.on('error', (e) => {
        console.error(e);
        showMessage('æ’­æ”¾æ³¢å½¢åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
      });
    }

    /**
     * è¼‰å…¥ä¸¦é¡¯ç¤ºæ³¢å½¢åœ–
     * @param {Blob} audioBlob éŒ„è£½çš„éŸ³è¨Š Blob
     */
    function loadWaveform(audioBlob) {
      const audioURL = URL.createObjectURL(audioBlob);
      wavesurfer.load(audioURL);
      wavesurfer.on('ready', () => {
        waveformContainer.style.display = 'block';
      });
      wavesurfer.on('error', (e) => {
        console.error(e);
        showMessage('è¼‰å…¥æ³¢å½¢åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
      });
    }

    // é–‹å§‹è¨ˆæ™‚å™¨
    function startTimer() {
      let seconds = 0;
      timerDisplay.textContent = '00:00';
      
      timerInterval = setInterval(() => {
        seconds++;
        if (seconds >= currentRecordingDuration) { // æ ¹æ“šè¨­å®šçš„éŒ„éŸ³æ™‚é•·
          stopTimer();
          if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
          }
        }
        const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        timerDisplay.textContent = `${mins}:${secs}`;
      }, 1000);
    }

    // åœæ­¢è¨ˆæ™‚å™¨
    function stopTimer() {
      clearInterval(timerInterval);
      timerDisplay.textContent = '00:00';
    }
  </script>
</body>
</html>